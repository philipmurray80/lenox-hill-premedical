function processSelection(e){var t=window.getSelection(),n=filterSelection(t);if(!n)return!1;var a=document.getElementById("highlightButton");a.style.top=e.pageY+"px",a.style.left=e.pageX+"px",a.onmousedown=function(){highlightRange(n),document.getElementById("highlightButton").style.display="none",window.getSelection().removeAllRanges(),window.event.stopPropagation()},a.style.display="inline",t.removeAllRanges(),t.addRange(n),a.focus()}function getTextNodesIn(e){var t=[];if(e)if(3==e.nodeType)t.push(e);else for(var n=e.childNodes,a=0,o=n.length;o>a;++a)t.push.apply(t,getTextNodesIn(n[a]));return t}function hideHighlightButton(){document.getElementById("highlightButton").style.display="none"}function highlightRange(e){var t=document.getElementById("annotationCount").value;t++;for(var n=getArray(e),a=0;a<n.length;a++)if(3!=n[a].startContainer.nodeType&&3!=n[a].endContainer.nodeType){for(var o=n[a].startOffset;o<n[a].endOffset;o++)for(var i=getTextNodesIn(n[a].startContainer.childNodes[o]),r=0;r<i.length;r++)if("B"!=i[r].parentNode.nodeName){var d=i[r].cloneNode().textContent,l=document.createElement("b");l.setAttribute("class",t),l.textContent=d,l.onmousedown=function(){removeHighlightGroup(this)},i[r].parentNode.insertBefore(l,i[r]),i[r].parentNode.removeChild(i[r])}}else{var l=document.createElement("b");l.setAttribute("class",t),l.onmousedown=function(){removeHighlightGroup(this)},n[a].surroundContents(l)}document.getElementById("annotationCount").value=t,document.getElementById("annotationChanged").value="TRUE"}function removeHighlightGroup(e){for(var t=document.getElementsByClassName(e.className);t.length;)removeBTag(t[t.length-1]);var n=document.getElementById("passage");mcatNormalize(n),document.getElementById("annotationChanged").value="TRUE",window.event.stopPropagation()}function removeBTag(e){if(mcatNormalize(e),e.hasChildNodes())if(1==e.childNodes.length&&3==e.firstChild.nodeType)e.parentNode.insertBefore(e.firstChild,e),e.parentNode.removeChild(e);else for(var t=e.childNodes,n=0;n<t.length;n++)3!=t[n].nodeType&&removeBTag(t[n]);else e.parentNode.removeChild(e)}function getArray(e){var t=e.commonAncestorContainer,n=[],a=[];if(e.startContainer!=t){for(var o=e.startContainer;o!=t;o=o.parentNode)n.push(o);if(0<n.length)for(var o=0;o<n.length;o++){var i=document.createRange();o?(i.setStartAfter(n[o-1]),i.setEndAfter(n[o].lastChild)):(i.setStart(n[o],e.startOffset),i.setEndAfter(n[o].nodeType==Node.TEXT_NODE?n[o]:n[o].lastChild)),i.collapsed||a.push(i)}}var r=[],d=[];if(e.endContainer!=t){for(var o=e.endContainer;o!=t;o=o.parentNode)r.push(o);if(0<r.length)for(var o=0;o<r.length;o++){var i=document.createRange();o?(i.setStartBefore(r[o].firstChild),i.setEndBefore(r[o-1])):(i.setStartBefore(r[o].nodeType==Node.TEXT_NODE?r[o]:r[o].firstChild),i.setEnd(r[o],e.endOffset)),i.collapsed||d.unshift(i)}}if(0<n.length&&0<r.length){var l=document.createRange();l.setStartAfter(n[n.length-1]),l.setEndBefore(r[r.length-1]),l.collapsed||a.push(l)}var u=a.concat(d);return 0==u.length?[e]:u}function filterSelection(e){if(1!=e.rangeCount)return!1;var t=e.getRangeAt(0);if(1==t.collapsed)return!1;for(var n=t.commonAncestorContainer,a=document.getElementById("passage");n!=a;){if("BODY"==n.nodeName)return!1;n=n.parentNode}return t}function initializeAnnotations(){for(var e=document.getElementById("passage").getElementsByTagName("b"),t=0;t<e.length;t++)e[t].onmousedown=function(){removeHighlightGroup(this)}}function checkIfNormalizeOk(){var e=document.createElement("p");e.appendChild(document.createTextNode(" ")),e.appendChild(document.createTextNode(" ")),e.appendChild(document.createTextNode(" ")),document.getElementsByTagName("head")[0].appendChild(e),e.normalize(),1===e.childNodes.length&&(isNormalizeOk=!0),document.getElementsByTagName("head")[0].removeChild(e)}function getNextNode(e,t,n){"undefined"==typeof n&&(n=!0);var a;return n&&(a=e.firstChild),a=a||e.nextSibling,!a&&e.parentNode&&e.parentNode!==t?getNextNode(e.parentNode,t,!1):a}function mcatNormalize(e){if(isNormalizeOk)e.normalize();else{for(var t,n=[],a=e;a=getNextNode(a,e);)3===a.nodeType&&a.previousSibling&&3===a.previousSibling.nodeType?(t||(t=[a.previousSibling]),t.push(a)):t&&(n.push(t),t=null);n.forEach(function(e){var t;e.forEach(function(e,n){n>0?(t.nodeValue+=e.nodeValue,e.parentNode.removeChild(e)):t=e})})}}function getPeriodicTable(e){return newWindow=window.open(e,"Periodic Table","height=700,width=1100"),window.focus&&newWindow.focus(),!1}function focusForMarking(e){for(var t=document.getElementsByTagName(e.tagName),n=0;n<t.length;n++)t[n].style.display="none";e.style.display="block";var a=e.getElementsByTagName("input")[0].name,o=document.getElementById("previousButton");o&&(o.style.visibility="visible",(1==a||60==a||113==a||172==a)&&(o.style.visibility="hidden")),modifyMarkButton(e)}function modifyMarkButton(e){var t=e.getElementsByTagName("input")[1].name,n=document.getElementById("mark_button");n.setAttribute("currentItem",t),isMarked(e)?(n.setAttribute("class","mcat_marked_button"),n.value="MARKED"):(n.setAttribute("class","mcat_submit_button"),n.value="MARK")}function isMarked(e){var t=e.getElementsByTagName("input")[1];return"m"==t.value.substr(1,1)?!0:!1}function clickMarkButton(){for(var e=document.getElementById("mark_button"),t=e.getAttribute("currentItem"),n=document.getElementsByTagName("fieldset"),a=0;a<n.length;a++)if(n[a].getElementsByTagName("input")[0].name==t){var o=n[a];break}removeExtraField(o),0==isMarked(o)?markItem(o):unmarkItem(o),updateExtraField(o),modifyMarkButton(o)}function markItem(e){for(var t=e.getElementsByTagName("input"),n=0;n<t.length;n++)t[n].value=t[n].value.concat("m")}function unmarkItem(e){for(var t=e.getElementsByTagName("input"),n=0;n<t.length;n++)t[n].value=t[n].value.substr(0,1)}function modifyMarkButton(e){var t=e.getElementsByTagName("input")[0];itemNumber=t.name;var n=document.getElementById("mark_button");n.setAttribute("currentItem",itemNumber),"m"==t.value.substr(1,1)?(n.setAttribute("class","mcat_marked_button"),n.value="MARKED"):(n.setAttribute("class","mcat_submit_button"),n.value="MARK")}function initializeMcatChecks(){for(var e=document.getElementsByTagName("fieldset"),t=0;t<e.length;t++)for(var n=e[t].getElementsByTagName("input"),a=0;a<n.length;a++)"checked"==n[a].getAttribute("checked")?n[a].setAttribute("mcat_checked","checked"):n[a].setAttribute("mcat_checked","unchecked")}function initializeExtraFields(){for(var e=document.getElementsByTagName("fieldset"),t=0;t<e.length;t++)updateExtraField(e[t])}function mcatCheck(e){var t=e.parentNode.parentNode.parentNode;if(removeExtraField(t),"checked"==e.getAttribute("mcat_checked"))e.checked=!1,e.setAttribute("mcat_checked","unchecked");else{for(var n=t.getElementsByTagName("input"),a=0;a<n.length;a++)n[a].setAttribute("mcat_checked","unchecked");e.setAttribute("mcat_checked","checked");var o=e.parentNode.nextSibling.firstChild;isStrikedOut(o)&&unStrikeOut(o)}updateExtraField(t)}function removeExtraField(e){var t=e.getElementsByTagName("input")[1].name,n="extra".concat(t),a=document.getElementById(n);null!==a&&a.parentNode.removeChild(a)}function updateExtraField(e){isIncomplete(e)&&(isMarked(e)?addIncompleteMarkedInputField(e):addIncompleteUnmarkedInputField(e))}function isIncomplete(e){for(var t=e.getElementsByTagName("input"),n=0;n<t.length;n++)if("checked"==t[n].getAttribute("mcat_checked"))return!1;return!0}function addIncompleteUnmarkedInputField(e){var t=e.getElementsByTagName("input")[1].name,n=document.createElement("input");n.id="extra".concat(t),n.type="hidden",n.name=t,n.value="null",e.appendChild(n)}function addIncompleteMarkedInputField(e){var t=e.getElementsByTagName("input")[1].name,n=document.createElement("input");n.id="extra".concat(t),n.type="hidden",n.name=t,n.value="m",e.appendChild(n)}function strikeOut(e){e.style.textDecoration="line-through";var t=e.getElementsByTagName("img")[0];void 0!==t&&(t.style.opacity="0.3",t.style.filter="alpha(opacity=30)")}function unStrikeOut(e){e.style.textDecoration="none";var t=e.getElementsByTagName("img")[0];void 0!==t&&(t.style.opacity="1.0",t.style.filter="alpha(opacity=100)")}function isStrikedOut(e){if("line-through"==e.style.textDecoration)return!0;var t=e.getElementsByTagName("img")[0];return void 0===t||"0.3"!=t.style.opacity&&"alpha(opacity=30)"!=t.style.filter?!1:!0}function updateStrikeOut(e){"unchecked"==e.parentNode.previousSibling.firstChild.getAttribute("mcat_checked")&&(isStrikedOut(e)?unStrikeOut(e):strikeOut(e))}function clickNextButton(){var e=document.getElementById("mark_button"),t=e.getAttribute("currentItem"),n=document.getElementsByTagName("fieldset"),a=n.length-1;if(t!=n[a].getElementsByTagName("input")[0].name){for(var o=0;o<n.length;o++)if(n[o].getElementsByTagName("input")[0].name==t){var i=n[o+1];break}return focusForMarking(i),!1}if("TRUE"==document.getElementById("annotationChanged").value){var r=document.getElementById("passage").innerHTML;document.getElementById("annotation").value=r}}function clickPreviousButton(){var e=document.getElementById("mark_button"),t=e.getAttribute("currentItem"),n=document.getElementsByTagName("fieldset");if(t!=n[0].getElementsByTagName("input")[0].name){for(var a=0;a<n.length;a++)if(n[a].getElementsByTagName("input")[0].name==t){var o=n[a-1];break}return focusForMarking(o),!1}if("TRUE"==document.getElementById("annotationChanged").value){var i=document.getElementById("passage").innerHTML;document.getElementById("annotation").value=i}}function clickReviewButton(){if("TRUE"==document.getElementById("annotationChanged").value){var e=document.getElementById("passage").innerHTML;document.getElementById("annotation").value=e}}var isNormalizeOk=!1;